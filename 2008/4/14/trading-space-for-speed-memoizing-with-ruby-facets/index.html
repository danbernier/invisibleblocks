<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Trading Space for Speed: Memoizing with Ruby Facets | </title>
    <meta name="description" content="I make <a href='http://wordcram.org'>WordCram</a>, and try to make generative art in <a href='http://processing.org'>Processing</a>. I read a fair bit, and I try to write well. I co-organize <a href='http://newhaven.io'>NewHaven.IO</a> and <a href='http://newhavenrb.org'>NewHaven.rb</a>. This is my blog.
">

    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="/2008/4/14/trading-space-for-speed-memoizing-with-ruby-facets/">

    <script src="/javascript/main.js"></script>
    <script src="/javascript/p5.min.js"></script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Invisible Blocks</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">What's all this, then?</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Trading Space for Speed: Memoizing with Ruby Facets</h1>
    <p class="post-meta">Apr 14, 2008 • Dan Bernier</p>
  </header>

  <article class="post-content">
    <p>Recently, I talked about a <a href="/2008/3/22/a-faster-cheaper-fibonacci-definition/">faster, cheaper way</a> to calculate <a href="http://en.wikipedia.org/wiki/Fibonacci_number">Fibonacci</a> numbers.  One of the optimizations I made was to remember the value of each Fibonacci number:  since F(7) is always 13, instead of recalculating it each time N=7, we can stuff <em>7 -&gt; 13</em> into a look-up table for future reference. The function builds up a cheat-sheet, to avoid doing the re-work.  It remembers.</p>

<p>This is called <a href="http://en.wikipedia.org/wiki/Memoization">memoization</a>, and it’s a nice way to trade memory for performance.  But it only works when the function always returns the same answer for a given set of arguments – otherwise it’s first-in wins, forever.  This property of a function, returning the same answer for the same args, is called <a href="http://en.wikipedia.org/wiki/Referential_transparency_%28computer_science%29">referential transparency</a>.</p>

<h4 id="a-sample-implementation">A Sample Implementation</h4>

<p>There are lots of ways you could memoize a function.  Hash tables are a natural choice, since they map a key to a value, just like functions map arguments to a value.  Even if you implement it differently, a hash table is a good working model for memoization.</p>

<p>Let’s briefly consider factorials.  The regular version:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Unmemoized</span>
    <span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="nb">puts</span> <span class="n">n</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span>
            <span class="mi">1</span>
        <span class="k">else</span>
            <span class="n">n</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">unmemoized</span> <span class="o">=</span> <span class="no">Unmemoized</span><span class="p">.</span><span class="nf">new</span>

<span class="mi">5</span><span class="p">.</span><span class="nf">downto</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"</span><span class="se">\t</span><span class="si">#{</span><span class="n">unmemoized</span><span class="p">.</span><span class="nf">factorial</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>…and the memoized version:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">Memoized</span>
    <span class="kp">attr_reader</span> <span class="ss">:factorial_memo</span>
    <span class="k">def</span> <span class="nf">initialize</span>
        <span class="vi">@factorial_memo</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="nb">puts</span> <span class="n">n</span>
        <span class="k">unless</span> <span class="vi">@factorial_memo</span><span class="p">.</span><span class="nf">has_key?</span> <span class="n">n</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span>
                <span class="vi">@factorial_memo</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span>
                <span class="vi">@factorial_memo</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">end</span>
        <span class="k">end</span>

        <span class="vi">@factorial_memo</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">memoized</span> <span class="o">=</span> <span class="no">Memoized</span><span class="p">.</span><span class="nf">new</span>

<span class="mi">5</span><span class="p">.</span><span class="nf">downto</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"</span><span class="se">\t</span><span class="si">#{</span><span class="n">memoized</span><span class="p">.</span><span class="nf">factorial</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>

<span class="nb">puts</span> <span class="n">memoized</span><span class="p">.</span><span class="nf">factorial_memo</span><span class="p">.</span><span class="nf">inspect</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Printing the hashtable is especially telling:  <code class="highlighter-rouge"><span class="p">{</span><span class="err">5=&gt;120,</span><span class="w"> </span><span class="err">0=&gt;1,</span><span class="w"> </span><span class="err">1=&gt;1,</span><span class="w"> </span><span class="err">2=&gt;2,</span><span class="w"> </span><span class="err">3=&gt;6,</span><span class="w"> </span><span class="err">4=&gt;24</span><span class="p">}</span></code> It reads like a look-up table for factorials.</p>

<h4 id="memoization-in-facets">Memoization in Facets</h4>

<p>As relatively easy as that example is, it has its drawbacks: we need to track our previous results in a separate variable, the memoization code is mixed up with the actual calculation (the part we care about), we can’t easily use it with other functions, and the pattern only works for functions of one argument.  <a href="http://facets.rubyforge.org/">Facets</a> makes memoization trivial, and removes all these issues.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><pre><span class="nb">require</span> <span class="s1">'facets/memoize'</span>

<span class="k">class</span> <span class="nc">FacetsMemoized</span>
    <span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="nb">puts</span> <span class="n">n</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span>
            <span class="mi">1</span>
        <span class="k">else</span>
            <span class="n">n</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">memoize</span> <span class="ss">:factorial</span> <span class="c1"># &lt;= HINT</span>
<span class="k">end</span>

<span class="n">facets_memoized</span> <span class="o">=</span> <span class="no">FacetsMemoized</span><span class="p">.</span><span class="nf">new</span>

<span class="mi">5</span><span class="p">.</span><span class="nf">downto</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">"</span><span class="se">\t</span><span class="si">#{</span><span class="n">facets_memoized</span><span class="p">.</span><span class="nf">factorial</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>In case you missed it, this is just like <code class="highlighter-rouge">Unmemoized</code> above, except we added line 13, <code class="highlighter-rouge">memoize :factorial</code>…that’s it.  Just like <code class="highlighter-rouge">attr_reader</code> and friends, you can pass a list of symbols to <code class="highlighter-rouge">memoize</code>, and it’ll work on functions with any number of arguments:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="nb">require</span> <span class="s1">'facets/memoize'</span>

<span class="k">class</span> <span class="nc">MemoizedMath</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+</span> <span class="n">m</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">mult</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">*</span> <span class="n">m</span>
    <span class="k">end</span>
    <span class="n">memoize</span> <span class="ss">:add</span><span class="p">,</span> <span class="ss">:mult</span>
<span class="k">end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h4 id="when-you-might-use-memoization-and-what-to-avoid">When You Might Use Memoization, and What to Avoid</h4>

<p>There are a number of places where this is useful: calculating a value by <a href="http://mitpress.mit.edu/sicp/full-text/sicp/book/node12.html">successive approximation</a>, finding the path to the root node in an immutable tree structure, finding the _N_th number in a recursively-defined series, even simple derived values (like ‘abc’.upcase).  In general, a function is a good candidate if it only looks at its arguments (no global, class, or member variables, no files or databases) – especially if those arguments are immutable.</p>

<p>Relying on side-effects (printing to standard out, writing to a database or file, or updating a variable) in memoized methods is a bad idea: they’ll only happen the first time your method is called with those arguments, which is probably not what you intend. (Unless you’re printing the arguments to illustrate how memoizing works.) On the other hand, relying on side-effects <a href="http://www.google.com/search?q=favor+immutability">is generally a bad idea</a> anyway. Even if you don’t use a functional programming language, you can still benefit from minimizing state changes.</p>

<h4 id="further-reading">Further Reading</h4>

<p>If memoization sounds interesting to you, you might like Oliver Steele’s article about <a href="http://osteele.com/archives/2006/04/javascript-memoization">memoizing JavaScript functions</a>.  If you’re curious about immutability, you might like this <a href="http://www.artima.com/intv/blochP.html">Joshua Bloch interview</a>.  If you’re interested in functional programming, there are worse places to start than the excellent <a href="http://mitpress.mit.edu/sicp/full-text/book/book.html">Structure and Interpretation of Computer Programs</a>.  And of course, there’s more where that came from, in <a href="http://facets.rubyforge.org/">Ruby Facets</a>.</p>

  </article>

  

  <a id='comments'></a>
  <h3>6 Comments on "Trading Space for Speed: Memoizing with Ruby Facets"</h3>

  
  <div class='comment'>
    <div><p>Why not rewrite Memoized like this: http://pastie.textmate.org/180528?</p>
</div>

    
    <span class='author'>
      <a href="http://judofyr.net">Magnus Holm</a>
    </span>
    

    <span class='date'>Mon Apr 14 11:39:52 2008</span>
  </div>
  
  <div class='comment'>
    <div><p>@Magnus, that’s a much nicer version of Memoized, I should have thought of that.  All I can say in my defense is that I was thinking more about the article and example, and less about the ruby code itself.  But I think the points I raised are still valid:</p>

<ul>
  <li>
    <p>“we need to track our previous results in a separate variable”  Still true.</p>
  </li>
  <li>
    <p>“the memoization code is mixed up with the actual calculation (the part we care about)”  Still true, but barely.  This is a great example of how ruby can redeem bad code.</p>
  </li>
  <li>
    <p>“we can’t easily use it with other functions”  You can use the <i>pattern</i> in other classes, but not the code itself.</p>
  </li>
  <li>
    <p>“the pattern only works for functions of one argument”  Still true.  Of course, if you look at the facets source, you can see this is pretty easy anyway, since ruby lets us use Arrays as Hash keys.</p>
  </li>
</ul>

<p>Facets wraps it up so nicely, I can’t think of a good reason to avoid it, unless I’m explicitly trying to avoid dependencies.</p>
</div>

    
    <span class='author'>Dan Bernier</span>
    

    <span class='date'>Mon Apr 14 13:15:12 2008</span>
  </div>
  
  <div class='comment'>
    <div><p>[…] Hoy en día encuentro 2 tendencias, a los que les vale optimizar y los que quieren pero frecuentemente caen en optimizaciones absurdas. Pocas veces uno puede decir “haz esto”; sin poner una lista interminable de cuando sí, cuando no. Pero hoy les digo que pueden hacer que sus funciones recuerden. […]</p>
</div>

    
    <span class='author'>
      <a href="http://tecnogemas.wordpress.com/2008/04/16/gem-install-facets/">gem install facets « Tecnogemas</a>
    </span>
    

    <span class='date'>Wed Apr 16 13:27:46 2008</span>
  </div>
  
  <div class='comment'>
    <div><p>You might also want to take a look at ‘memoize’ as mentioned in the Pickaxe:
http://raa.ruby-lang.org/project/memoize/</p>
</div>

    
    <span class='author'>
      <a href="http://djwonk.com">David James</a>
    </span>
    

    <span class='date'>Sun Oct 18 02:21:40 2009</span>
  </div>
  
  <div class='comment'>
    <div><p>You know the Ruby convention for indenting is 2 spaces?</p>
</div>

    
    <span class='author'>Ruby Convention</span>
    

    <span class='date'>Sun Oct 18 02:25:34 2009</span>
  </div>
  
  <div class='comment'>
    <div><p>Indeed I do.  My editor at the time, programmer’s notepad 2, didn’t allow different tab widths for each language, so I left it at 4, to match all the other languages I often use.  Conventions are great, but they’re just that.</p>
</div>

    
    <span class='author'>Dan Bernier</span>
    

    <span class='date'>Wed Oct 21 07:59:17 2009</span>
  </div>
  

  
</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">


    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <h2 class="footer-heading">Invisible Blocks</h2>
        <p class="text">for building invisible machines</p>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/danbernier">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">danbernier</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/danbernier">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">danbernier</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">I make <a href='http://wordcram.org'>WordCram</a>, and try to make generative art in <a href='http://processing.org'>Processing</a>. I read a fair bit, and I try to write well. I co-organize <a href='http://newhaven.io'>NewHaven.IO</a> and <a href='http://newhavenrb.org'>NewHaven.rb</a>. This is my blog.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
