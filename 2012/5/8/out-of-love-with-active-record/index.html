<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Out of Love with Active Record | </title>
    <meta name="description" content="I make <a href='http://wordcram.org'>WordCram</a>, and try to make generative art in <a href='http://processing.org'>Processing</a>. I read a fair bit, and I try to write well. I co-organize <a href='http://newhaven.io'>NewHaven.IO</a> and <a href='http://newhavenrb.org'>NewHaven.rb</a>. This is my blog.
">

    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="/2012/5/8/out-of-love-with-active-record/">

    <script src="/javascript/main.js"></script>
    <script src="/javascript/p5.min.js"></script>
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Invisible Blocks</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">What's all this, then?</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Out of Love with Active Record</h1>
    <p class="post-meta">May 8, 2012 • Dan Bernier</p>
  </header>

  <article class="post-content">
    <p>(I’m a new-comer to Rails. When I first found Ruby, and Rails, I liked the Ruby better. And I never found many Rails jobs near home anyway. So for years, Ruby flavored my C#, and C# is where I learned, among other things, to persist my domain aggregates with NHibernate. Now I’m a card-carrying Rails jobber, which is great, because I play with Ruby all day. And the Rails community is discovering domain-driven design, and ORMs…)</p>

<p>Steve Klabnik just posted about <a href="http://blog.steveklabnik.com/posts/2012-05-07-mixins--a-refactoring-anti-pattern">resisting the urge to factor your models into behavior-in-a-mixin and dumb-persistence-with-active-record</a>. He nails it when he says:</p>
<blockquote>
Whenever we refactor, we have to consider what we're using to evaluate that our refactoring has been successful. For me, the default is complexity. That is, any refactoring I'm doing is trying to reduce complexity... One good way that I think about complexity on an individual object level [is its] 'attack surface.' We call this 'encapsulation' in object oriented software design.</blockquote>

<p>If you learn only one thing from his post, let it be that “mixins do not really reduce the complexity of your objects.” Greg Brown threw me when he said that mixins are just another form of inheritance, and I think he was getting at the same thing.</p>

<p>Steve’s suggestion for separating persistence and behavior is to - duh, once you see it - separate them into different classes: a Post and a PostMapper, or a Post and a PostRepository. When I used C# and NHibernate, we loaded our Posts from the PostRepository, which used our PostMapper for data access. (Actually, our PostMapper was an XML mapping file.) You might call that overkill, but in a legacy app, it was nice to sheetrock our repositories over all the different data access technologies we’d acquired over the years, from the shiny new ORM to the crusty old Strongly-Typed DataSets.</p>

<p>When I was on that team, the thing that we worried about was, what grain should we build our repositories at? We didn’t have simple models, we had domain aggregates: we’d load a ThirdPartyAdministrator, which had many Clients, which each had a number of Accounts of different types, each of which had different options and sub-objects. So, what kind of repositories should we build, and what methods should they have? If we want to load the Client’s Accounts, should we load the ThirdPartyAdministrator, find the Client, and get its Accounts? load the Accounts directly? load the Client, and get its Accounts?</p>

<p>For a ridiculously simplified example, but to give you the flavor of it, say we load the ThirdPartyAdministrator, the aggregate root, and go from there:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">ThirdPartyAdministratorRepository</span>
  <span class="k">def</span> <span class="nf">load_tpa</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">end</span>
<span class="k">end</span>

<span class="n">tpa</span> <span class="o">=</span> <span class="no">ThirdPartyAdministratorRepositor</span><span class="p">.</span><span class="nf">load_tpa</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">tpa</span><span class="p">.</span><span class="nf">clients</span><span class="p">[</span><span class="n">client_id</span><span class="p">]</span>
<span class="n">accounts</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">accounts</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>That’s too coarse; do we really have to load the TPA before we can get the client we’re after?</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">ClientRepository</span>
  <span class="k">def</span> <span class="nf">load_client</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">AccountRepository</span>
  <span class="k">def</span> <span class="nf">load_account</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">end</span>
<span class="k">end</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">ClientRepository</span><span class="p">.</span><span class="nf">load_client</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
<span class="n">accounts</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">account_ids</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="nb">id</span><span class="o">|</span>
  <span class="no">AccountRepository</span><span class="p">.</span><span class="nf">load_account</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>That’s too fine a grain, too low-level; we don’t want to have to muck around with Account IDs.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="n">client</span> <span class="o">=</span> <span class="no">ClientRepository</span><span class="p">.</span><span class="nf">load_client</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
<span class="n">accounts</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">accounts</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>That might be a good middle-approach.</p>

<p>It comes down to knowing your application’s data-access patterns, and your domain’s constraints. If you often need a chunk of data, all together, you should probably have a repository for it. If one piece of data depends on another, your repository probably shouldn’t make you get them separately.</p>

<p>With Rails’ ActiveRecord, all this is sorted out for you - you define your associations, it provides all those querying methods, and you use the correct ones for what you need. With repositories, you have decisions to make - you have to design it, and design is choice. But choosing is work! and you can choose inconsistently! sometimes, it even makes sense to! I’m curious to see how the Rails community, with its culture of convention, tackles this. And for myself, I plan to check out DataMapper at some point.</p>

  </article>

  

  <a id='comments'></a>
  <h3>1 Comments on "Out of Love with Active Record"</h3>

  
  <div class='comment'>
    <div><p>Thank you. You’ve validated both the sense of dread I feel when I consider moving beyond Active Record, and the sense of hope I feel about the potential results.</p>

<p>Here’s where I’m at with this:</p>

<p>http://starjuice.net/post/27254089033/active-records-vs-objects</p>
</div>

    
    <span class='author'>
      <a href="http://starjuice.net/">Sheldon Hearn</a>
    </span>
    

    <span class='date'>Sun Jul 15 08:55:46 2012</span>
  </div>
  

  
</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">


    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <h2 class="footer-heading">Invisible Blocks</h2>
        <p class="text">for building invisible machines</p>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/danbernier">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">danbernier</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/danbernier">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">danbernier</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">I make <a href='http://wordcram.org'>WordCram</a>, and try to make generative art in <a href='http://processing.org'>Processing</a>. I read a fair bit, and I try to write well. I co-organize <a href='http://newhaven.io'>NewHaven.IO</a> and <a href='http://newhavenrb.org'>NewHaven.rb</a>. This is my blog.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
